# 设计：增强速率限制处理

## 背景

当前代理服务具有基本的重试逻辑（3 次尝试，无延迟），并依赖后端轮询获取配额数据。用户遇到 429 错误时没有智能恢复机制，导致请求失败和糟糕的用户体验。

**利益相关者**：终端用户、共享代理的团队成员

**约束条件**：
- 不能显著增加成功请求的延迟
- 必须向后兼容现有配置
- 必须适配 Google Gemini API 的速率限制行为

## 目标 / 非目标

### 目标
- 将用户可见的 429 错误减少 90% 以上
- 在代理页面提供实时配额可视化
- 在配额耗尽前启用自动账号切换

### 非目标
- 多提供商支持（OpenAI/Anthropic 作为后端）- 单独变更
- 服务端响应缓存
- 复杂的负载均衡算法

## 决策

### 决策 1：指数退避策略

**内容**：实现带抖动的指数退避重试。

**原因**：处理速率限制的行业标准。抖动防止多个请求同时重试时的"惊群效应"。

**公式**：
```
delay = min(maxDelay, initialDelay * (2 ^ attempt) * (1 + random * jitterFactor))
```

**默认值**：
- `initialDelayMs`: 1000 (1 秒)
- `maxDelayMs`: 30000 (30 秒)
- `maxRetries`: 5
- `jitterFactor`: 0.3

### 决策 2：滑动窗口追踪 RPM

**内容**：使用滑动窗口计数器（60 秒窗口）追踪每个账号的每分钟请求数。

**原因**：比固定窗口计数器更准确；防止窗口边界的突发流量问题。

**实现**：时间戳数组，每次访问时过滤出最近 60 秒的记录。

### 决策 3：预请求配额检查

**内容**：发送请求前，检查该账号的本地 RPM 计数器是否超过已知限制的 80%。

**原因**：主动切换可防止触发速率限制；80% 阈值提供缓冲。

**回退方案**：若本地追踪不可用，则继续发送请求并被动处理 429。

## 风险 / 权衡

| 风险 | 缓解措施 |
|------|----------|
| 退避延迟增加响应时间 | 较短的初始延迟（1秒）；高级用户可配置 |
| RPM 追踪在重启后不准确 | 可接受；追踪重置，最坏情况是几个 429 |
| 滑动窗口的内存使用 | 限制每个账号 1000 条记录；足够 60 秒窗口使用 |

## 迁移计划

1. 添加带默认值的新配置字段（向后兼容）
2. 现有用户自动获得退避功能；无需任何操作
3. 配额仪表盘通过代理页面查看（可选）

## 待解答问题

1. 是否应将 RPM 计数器持久化到磁盘以应对重启？（可能不需要 - 复杂度 vs 收益）
2. 是否应将指标暴露给外部监控（Prometheus）？（后续变更）
